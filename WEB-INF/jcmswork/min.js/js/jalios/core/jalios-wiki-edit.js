!function(f){var b=function(){s();n();h()};var a=false;var d=false;var v=false;var j=false;var r=false;var s=function(){a='<img alt="" src="images/jalios/icons/editSmall.gif" class="icon">';a='<button class="wiki-action wiki-edit-section hidden-print btn btn-link">'+a+"</button>";d='<button class="wiki-action wiki-save-section btn btn-primary btn-xs">'+f.jalios.I18N.glp("wiki.section.save")+"</button>";v='<button class="wiki-action wiki-cancel-section btn btn-default btn-xs">'+f.jalios.I18N.glp("wiki.section.cancel")+"</button>";f(document).on("click",".wiki-edit-section",g);f(document).on("click",".wiki-save-section",g);f(document).on("click",".wiki-cancel-section",g);j=f('<div id="edit-widget" class="edit-widget" ></div>').appendTo(document.body);f(document).on("jalios:refresh",h)};var g=function(y){y.preventDefault();var x=f(y.currentTarget);if(x.hasClass("wiki-edit-section")){q(x)}else{if(x.hasClass("wiki-save-section")){u(x)}else{if(x.hasClass("wiki-cancel-section")){c(x)}}}};var q=function(z){c();var x=o(z);if(!x.id||!x.field){return}var A=i(x);if(!A){return}j.css("left",A.left+"px").css("top",A.top+"px").css("width",A.width+"px").css("height",A.height+"px").show();var y="jcore/wiki/wikiSection.jsp?";y+="id="+x.id+"&field="+x.field+"&section="+x.index+"&mdate="+x.mdate+(x.wikiwygOptionSet?"&wikiwyg="+x.wikiwyg:"");z.refresh({url:y,target:j,noscroll:true,nohistory:true,callback:l})};var u=function(z){var x=o(z);if(!x.id||!x.field){return}var B=j.find("TEXTAREA");var A=window.tinyMCE!=undefined&&tinyMCE.get(B.attr("id"));if(A){A.save()}var y="jcore/wiki/wikiSection.jsp?";y+="id="+x.id+"&field="+x.field+"&section="+x.index+"&mdate="+x.mdate;y+="&update="+encodeURIComponent(B.val());z.refresh({url:y,noresponse:true,callback:function(){c();z.refresh({noscroll:true,nohistory:true})}})};var c=function(y){if(!r){return}r.removeClass("wiki-editing");j.hide();if(!y){return}var z=y.closest(".wiki-edit").getJcmsId();var x="jcore/wiki/wikiSection.jsp?id="+z+"&unlock=true";y.refresh({url:x,noresponse:true})};var h=function(z){var x=f(document);var y=f.jalios.Event.match(z,"refresh","after");if(y&&y.target){x=y.target}x.find(".wiki-edit").each(function(){var A=f(this);if(!A.hasClass("wiki-edit-upgrade")){A.addClass("wiki-edit-upgrade");A.append(a).append(d).append(v)}A.find(".wiki-section").not(".wiki-section-upgrade").each(function(){f(this).addClass("wiki-section-upgrade").append(a).append(d).append(v)})})};var l=function(){var x=j.find("TEXTAREA");if(f.browser.msie){x.attr("rows","1");x.css("height",(j.height()-4)+"px")}if(x.hasClass("formWikiwyg")){p.defer(x)}};var p=function(A){var y=window.tinyMCE!=undefined&&tinyMCE.get(A.attr("id"));if(!y){p.defer(A);return}var x=f("#"+y.id+"_tbl");var z=f("#"+y.id+"_ifr");z.css("width",j.width()+"px").css("height",j.height()+"px");x.css("width",j.width()+"px").css("height",j.height()+"px")};var o=function(x){var z=x.closest(".wiki-section");var y=x.closest(".wiki-edit");return{section:z,index:k(z),wrapper:y,id:y.getJcmsId(),field:y.matchClass(/wiki-field-(\S+)/g),mdate:y.matchClass(/wiki-mdate-(\d+)/g),wikiwyg:y.hasClass("wikiwyg"),wikiwygOptionSet:y.hasClass("wikiwyg")||y.hasClass("no-wikiwyg")}};var k=function(A){if(!A.exists()){return 0}var x="";var y=parseInt(A.prop("tagName").match(/\d/));var z=1;A.prevUntil(false,".wiki-section").each(function(){var B=parseInt(f(this).prop("tagName").match(/\d/));if(B==y){z++}if(B<y){y=B;x=z+"-"+x;z=1}});x=z+"-"+x;return x.substring(0,x.length-1)};var w=function(z){var y=parseInt(z.prop("tagName").match(/\d/));var x=false;z.nextUntil(false,".wiki-section").each(function(){var A=parseInt(f(this).prop("tagName").match(/\d/));if(A<=y){x=f(this);return false}});return x};var i=function(y){var A=y.section.exists()?y.section:y.wrapper;if(!A.exists()){return false}r=A;A.addClass("wiki-editing");if(!y.section.exists()){return y.wrapper.bounds()}var A=y.section;var z=A.bounds();var x=w(A);z.top+=z.height;z.height=x?x.bounds().top-z.bottom:y.wrapper.bounds().bottom-z.bottom;return z};var n=function(){f(document).on("focusin","TEXTAREA.wikiarea",function(){f.jalios.Wiki.showWikiToolbar(this)});f(document).on("jalios:refresh",function(y){var x=f.jalios.Event.match(y,"refresh","before");if(!x){return}e(x.target)})};var t=function(x){var A=f(x);var z=A.getWidget();if(!z.exists()){return}if(z.hasClass("disabled")){return}var y=f("#wikitoolbar");if(!y.exists()){return}A.after(y);WikiToolbar.hidePreview(null,x);y.show()};var e=function(x){m(f("#wikitoolbar"),x)};var m=function(x,y){if(!x.exists()){return}if(y.exists()&&!x.closest(y).exists()){return}x.appendTo(f(document.body));x.hide()};if(!f.jalios){f.jalios={}}f.jalios.Wiki={showWikiToolbar:t,hideWikiToolbar:e};f.jalios.Wiki.Edit={edit:q,save:u,cancel:c};f(document).ready(function(x){b()})}(window.jQuery);