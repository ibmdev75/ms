(function(a){if(typeof exports=="object"&&typeof module=="object"){a(require("../../lib/codemirror"))}else{if(typeof define=="function"&&define.amd){define(["../../lib/codemirror"],a)}else{a(CodeMirror)}}})(function(q){q.TernServer=function(M){var L=this;this.options=M||{};var K=this.options.plugins||(this.options.plugins={});if(!K.doc_comment){K.doc_comment=true}if(this.options.useWorker){this.server=new I(this)}else{this.server=new tern.Server({getFile:function(N,O){return F(L,N,O)},async:true,defs:this.options.defs||[],plugins:K})}this.docs=Object.create(null);this.trackChange=function(N,O){g(L,N,O)};this.cachedArgHints=null;this.activeArgHints=null;this.jumpStack=[]};q.TernServer.prototype={addDoc:function(K,M){var L={doc:M,name:K,changed:null};this.server.addFile(K,w(this,L));q.on(M,"change",this.trackChange);return this.docs[K]=L},delDoc:function(K){var L=this.docs[K];if(!L){return}q.off(L.doc,"change",this.trackChange);delete this.docs[K];this.server.delFile(K)},hideDoc:function(K){c(this);var L=this.docs[K];if(L&&L.changed){h(this,L)}},complete:function(K){var L=this;q.showHint(K,function(M,N){return o(L,M,N)},{async:true})},getHint:function(K,L){return o(this,K,L)},showType:function(K,L){A(this,K,L)},updateArgHints:function(K){m(this,K)},jumpToDef:function(K){b(this,K)},jumpBack:function(K){v(this,K)},rename:function(K){r(this,K)},selectName:function(K){e(this,K)},request:function(K,N,Q,P){var L=this;var O=j(this,K.getDoc());var M=t(this,O,N,P);this.server.request(M,function(R,S){if(!R&&L.options.responseFilter){S=L.options.responseFilter(O,N,M,R,S)}Q(R,S)})}};var l=q.Pos;var d="CodeMirror-Tern-";var J=250;function F(M,L,N){var K=M.docs[L];if(K){N(w(M,K))}else{if(M.options.getFile){M.options.getFile(L,N)}else{N(null)}}}function j(M,N,K){for(var P in M.docs){var O=M.docs[P];if(O.doc==N){return O}}if(!K){for(var L=0;;++L){P="[doc"+(L||"")+"]";if(!M.docs[P]){K=P;break}}}return M.addDoc(K,N)}function g(M,O,Q){var N=j(M,O);var K=M.cachedArgHints;if(K&&K.doc==O&&u(K.start,Q.to)<=0){M.cachedArgHints=null}var P=N.changed;if(P==null){N.changed=P={from:Q.from.line,to:Q.from.line}}var L=Q.from.line+(Q.text.length-1);if(Q.from.line<P.to){P.to=P.to-(Q.to.line-L)}if(L>=P.to){P.to=L+1}if(P.from>Q.from.line){P.from=Q.from.line}if(O.lineCount()>J&&Q.to-P.from>100){setTimeout(function(){if(N.changed&&N.changed.to-N.changed.from>100){h(M,N)}},200)}}function h(K,L){K.server.request({files:[{type:"full",name:L.name,text:w(K,L)}]},function(M){if(M){window.console.error(M)}else{L.changed=null}})}function o(L,K,M){L.request(K,{type:"completions",types:true,docs:true,urls:true},function(T,Q){if(T){return f(L,K,T)}var U=[],N="";var V=Q.start,W=Q.end;if(K.getRange(l(V.line,V.ch-2),V)=='["'&&K.getRange(W,l(W.line,W.ch+2))!='"]'){N='"]'}for(var R=0;R<Q.completions.length;++R){var O=Q.completions[R],S=x(O.type);if(Q.guess){S+=" "+d+"guess"}U.push({text:O.name+N,displayText:O.name,className:S,data:O})}var P={from:V,to:W,list:U};var X=null;q.on(P,"close",function(){s(X)});q.on(P,"update",function(){s(X)});q.on(P,"select",function(aa,Z){s(X);var Y=L.options.completionTip?L.options.completionTip(aa.data):aa.data.doc;if(Y){X=z(Z.parentNode.getBoundingClientRect().right+window.pageXOffset,Z.getBoundingClientRect().top+window.pageYOffset,Y);X.className+=" "+d+"hint-doc"}});M(P)})}function x(K){var L;if(K=="?"){L="unknown"}else{if(K=="number"||K=="string"||K=="bool"){L=K}else{if(/^fn\(/.test(K)){L="fn"}else{if(/^\[/.test(K)){L="array"}else{L="object"}}}}return d+"completion "+d+"completion-"+L}function A(L,K,M){L.request(K,"type",function(N,P){if(N){return f(L,K,N)}if(L.options.typeTip){var O=L.options.typeTip(P)}else{var O=C("span",null,C("strong",null,P.type||"not found"));if(P.doc){O.appendChild(document.createTextNode(" â€” "+P.doc))}if(P.url){O.appendChild(document.createTextNode(" "));O.appendChild(C("a",null,"[docs]")).href=P.url}}p(K,O)},M)}function m(T,X){c(T);if(X.somethingSelected()){return}var M=X.getTokenAt(X.getCursor()).state;var aa=q.innerMode(X.getMode(),M);if(aa.mode.name!="javascript"){return}var O=aa.state.lexical;if(O.info!="call"){return}var L,W=O.pos||0,R=X.getOption("tabSize");for(var Z=X.getCursor().line,S=Math.max(0,Z-9),Y=false;Z>=S;--Z){var U=X.getLine(Z),Q=0;for(var V=0;;){var P=U.indexOf("\t",V);if(P==-1){break}Q+=R-(P+Q)%R-1;V=P+1}L=O.column-Q;if(U.charAt(L)=="("){Y=true;break}}if(!Y){return}var N=l(Z,L);var K=T.cachedArgHints;if(K&&K.doc==X.getDoc()&&u(N,K.start)==0){return i(T,X,W)}T.request(X,{type:"type",preferFunction:true,end:N},function(ab,ac){if(ab||!ac.type||!(/^fn\(/).test(ac.type)){return}T.cachedArgHints={start:V,type:y(ac.type),name:ac.exprName||ac.name||"fn",guess:ac.guess,doc:X.getDoc()};i(T,X,W)})}function i(N,R,O){c(N);var K=N.cachedArgHints,P=K.type;var Q=C("span",K.guess?d+"fhint-guess":null,C("span",d+"fname",K.name),"(");for(var M=0;M<P.args.length;++M){if(M){Q.appendChild(document.createTextNode(", "))}var S=P.args[M];Q.appendChild(C("span",d+"farg"+(M==O?" "+d+"farg-current":""),S.name||"?"));if(S.type!="?"){Q.appendChild(document.createTextNode(":\u00a0"));Q.appendChild(C("span",d+"type",S.type))}}Q.appendChild(document.createTextNode(P.rettype?") ->\u00a0":")"));if(P.rettype){Q.appendChild(C("span",d+"type",P.rettype))}var L=R.cursorCoords(null,"page");N.activeArgHints=z(L.right+1,L.bottom,Q)}function y(O){var N=[],P=3;function L(Q){var S=0,T=P;for(;;){var R=O.charAt(P);if(Q.test(R)&&!S){return O.slice(T,P)}if(/[{\[\(]/.test(R)){++S}else{if(/[}\]\)]/.test(R)){--S}}++P}}if(O.charAt(P)!=")"){for(;;){var M=O.slice(P).match(/^([^, \(\[\{]+): /);if(M){P+=M[0].length;M=M[1]}N.push({name:M,type:L(/[\),]/)});if(O.charAt(P)==")"){break}P+=2}}var K=O.slice(P).match(/^\) -> (.*)$/);return{args:N,rettype:K&&K[1]}}function b(M,K){function L(P){var N={type:"definition",variable:P||null};var O=j(M,K.getDoc());M.server.request(t(M,O,N),function(Q,S){if(Q){return f(M,K,Q)}if(!S.file&&S.url){window.open(S.url);return}if(S.file){var T=M.docs[S.file],R;if(T&&(R=G(T.doc,S))){M.jumpStack.push({file:O.name,start:K.getCursor("from"),end:K.getCursor("to")});a(M,O,T,R.start,R.end);return}}f(M,K,"Could not find a definition.")})}if(!H(K)){E(K,"Jump to variable",function(N){if(N){L(N)}})}else{L()}}function v(L,K){var N=L.jumpStack.pop(),M=N&&L.docs[N.file];if(!M){return}a(L,j(L,K.getDoc()),M,N.start,N.end)}function a(M,L,N,O,K){N.doc.setSelection(K,O);if(L!=N&&M.options.switchToDoc){c(M);M.options.switchToDoc(N.name)}}function G(S,O){var Q=O.context.slice(0,O.contextOffset).split("\n");var U=O.start.line-(Q.length-1);var L=l(U,(Q.length==1?O.start.ch:S.getLine(U).length)-Q[0].length);var V=S.getLine(U).slice(L.ch);for(var T=U+1;T<S.lineCount()&&V.length<O.context.length;++T){V+="\n"+S.getLine(T)}if(V.slice(0,O.context.length)==O.context){return O}var W=S.getSearchCursor(O.context,0,false);var M,K=Infinity;while(W.findNext()){var R=W.from(),P=Math.abs(R.line-L.line)*10000;if(!P){P=Math.abs(R.ch-L.ch)}if(P<K){M=R;K=P}}if(!M){return null}if(Q.length==1){M.ch+=Q[0].length}else{M=l(M.line+(Q.length-1),Q[Q.length-1].length)}if(O.start.line==O.end.line){var N=l(M.line,M.ch+(O.end.ch-O.start.ch))}else{var N=l(M.line+(O.end.line-O.start.line),O.end.ch)}return{start:M,end:N}}function H(K){var M=K.getCursor("end"),L=K.getTokenAt(M);if(L.start<M.ch&&(L.type=="comment"||L.type=="string")){return false}return/\w/.test(K.getLine(M.line).slice(Math.max(M.ch-1,0),M.ch+1))}function r(M,K){var L=K.getTokenAt(K.getCursor());if(!/\w/.test(L.string)){f(M,K,"Not at a variable")}E(K,"New name for "+L.string,function(N){M.request(K,{type:"rename",newName:N,fullDocs:true},function(O,P){if(O){return f(M,K,O)}k(M,P.changes)})})}function e(N,K){var O=K.getCursor(),M=K.getTokenAt(O);if(!/\w/.test(M.string)){f(N,K,"Not at a variable")}var L=j(N,K.doc).name;N.request(K,{type:"refs"},function(Q,T){if(Q){return f(N,K,Q)}var P=[],U=0;for(var R=0;R<T.refs.length;R++){var S=T.refs[R];if(S.file==L){P.push({anchor:S.start,head:S.end});if(u(U,S.start)>=0&&u(U,S.end)<=0){U=P.length-1}}}K.setSelections(P,U)})}var B=0;function k(P,Q){var N=Object.create(null);for(var O=0;O<Q.length;++O){var K=Q[O];(N[K.file]||(N[K.file]=[])).push(K)}for(var L in N){var S=P.docs[L],M=N[L];if(!S){continue}M.sort(function(U,T){return u(T.start,U.start)});var R="*rename"+(++B);for(var O=0;O<M.length;++O){var K=M[O];S.doc.replaceRange(K.text,K.start,K.end,R)}}}function t(P,S,Q,R){var M=[],N=0,K=!Q.fullDocs;if(!K){delete Q.fullDocs}if(typeof Q=="string"){Q={type:Q}}Q.lineCharPositions=true;if(Q.end==null){Q.end=R||S.doc.getCursor("end");if(S.doc.somethingSelected()){Q.start=S.doc.getCursor("start")}}var O=Q.start||Q.end;if(S.changed){if(S.doc.lineCount()>J&&K!==false&&S.changed.to-S.changed.from<100&&S.changed.from<=O.line&&S.changed.to>Q.end.line){M.push(n(S,O,Q.end));Q.file="#0";var N=M[0].offsetLines;if(Q.start!=null){Q.start=l(Q.start.line- -N,Q.start.ch)}Q.end=l(Q.end.line-N,Q.end.ch)}else{M.push({type:"full",name:S.name,text:w(P,S)});Q.file=S.name;S.changed=null}}else{Q.file=S.name}for(var L in P.docs){var T=P.docs[L];if(T.changed&&T!=S){M.push({type:"full",name:T.name,text:w(P,T)});T.changed=null}}return{query:Q,files:M}}function n(S,L,Q){var X=S.doc;var O=null,M=null,P,T=4;for(var K=L.line-1,R=Math.max(0,K-50);K>=R;--K){var Y=X.getLine(K),V=Y.search(/\bfunction\b/);if(V<0){continue}var N=q.countColumn(Y,null,T);if(O!=null&&O<=N){continue}O=N;M=K}if(M==null){M=R}var U=Math.min(X.lastLine(),Q.line+20);if(O==null||O==q.countColumn(X.getLine(L.line),null,T)){P=U}else{for(P=Q.line+1;P<U;++P){var N=q.countColumn(X.getLine(P),null,T);if(N<=O){break}}}var W=l(M,0);return{type:"part",name:S.name,offsetLines:W.line,text:X.getRange(W,l(P,0))}}var u=q.cmpPos;function C(N,K){var O=document.createElement(N);if(K){O.className=K}for(var M=2;M<arguments.length;++M){var L=arguments[M];if(typeof L=="string"){L=document.createTextNode(L)}O.appendChild(L)}return O}function E(K,M,L){if(K.openDialog){K.openDialog(M+": <input type=text>",L)}else{L(prompt(M,""))}}function p(L,N){var M=L.cursorCoords();var O=z(M.right+1,M.bottom,N);function K(){if(!O.parentNode){return}L.off("cursorActivity",K);D(O)}setTimeout(K,1700);L.on("cursorActivity",K)}function z(K,N,M){var L=C("div",d+"tooltip",M);L.style.left=K+"px";L.style.top=N+"px";document.body.appendChild(L);return L}function s(K){var L=K&&K.parentNode;if(L){L.removeChild(K)}}function D(K){K.style.opacity="0";setTimeout(function(){s(K)},1100)}function f(L,K,M){if(L.options.showError){L.options.showError(K,M)}else{p(K,String(M))}}function c(K){if(K.activeArgHints){s(K.activeArgHints);K.activeArgHints=null}}function w(K,L){var M=L.doc.getValue();if(K.options.fileFilter){M=K.options.fileFilter(M,L.name,L.doc)}return M}function I(K){var O=new Worker(K.options.workerScript);O.postMessage({type:"init",defs:K.options.defs,plugins:K.options.plugins,scripts:K.options.workerDeps});var M=0,N={};function L(P,Q){if(Q){P.id=++M;N[M]=Q}O.postMessage(P)}O.onmessage=function(Q){var P=Q.data;if(P.type=="getFile"){F(K,P.name,function(R,S){L({type:"getFile",err:String(R),text:S,id:P.id})})}else{if(P.type=="debug"){window.console.log(P.message)}else{if(P.id&&N[P.id]){N[P.id](P.err,P.body);delete N[P.id]}}}};O.onerror=function(P){for(var Q in N){N[Q](P)}N={}};this.addFile=function(P,Q){L({type:"add",name:P,text:Q})};this.delFile=function(P){L({type:"del",name:P})};this.request=function(P,Q){L({type:"req",body:P},Q)}}});