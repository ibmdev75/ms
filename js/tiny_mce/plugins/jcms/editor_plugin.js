JcmsLogger.info("TinyMCE_JcmsPlugin","Loading TinyMCE JCMS plugin");(function(){var a=tinymce.DOM;tinyMCE.addI18n(jQuery.jalios.I18N.glp("lang.tinymce")+".jcms",{publink_desc:jQuery.jalios.I18N.glp("tinymce.jcms.publink_desc"),media_desc:jQuery.jalios.I18N.glp("tinymce.jcms.media_desc"),global_styles_desc:jQuery.jalios.I18N.glp("tinymce.jcms.global_styles_desc"),local_styles_desc:jQuery.jalios.I18N.glp("tinymce.jcms.local_styles_desc"),invisible_desc:jQuery.jalios.I18N.glp("tinymce.jcms.invisible_desc"),docchooser_desc:jQuery.jalios.I18N.glp("tinymce.jcms.docchooser_desc"),wikicode_desc:jQuery.jalios.I18N.glp("tinymce.jcms.wikicode_desc"),code_desc:jQuery.jalios.I18N.glp("tinymce.jcms.code_desc")});tinymce.create("tinymce.plugins.JcmsPlugin",{getInfo:function(){return{longname:"JCMS",author:"Jalios S.A.",authorurl:"http://support.jalios.com",infourl:"http://support.jalios.com",version:"3.4.3.2-7"}},init:function(b,d){var e=this;e.editor=b;e.url=d;JcmsLogger.debug("TinyMCE_JcmsPlugin","[",b.id,"] [init] url:",d,"");b.onBeforeRenderUI.add(function(){a.loadCSS(d+"/css/ui.css")});this.isWikiwyg=b.isWikiwyg=b.getParam("jcms_wikiwyg");b.wsId=$(b.getElement()).getJcmsId("WSID_");b.wsIdParam=(b.wsId&&b.wsId!="")?("&ws="+b.wsId):"";b.onInit.add(function(g){$(g.getElement()).addClassName("tinyMceInitialized")});var f=b.settings.body_class||"";if(f.indexOf("=")!=-1){f=e.getParam("body_class","","hash");f=bc[e.id]||""}b.settingsBodyClass=f;var c=(b.getElement?("&lang="+b.getElement().getAttribute("lang")):"");b.addCommand("jcmsPublink",function(){JcmsLogger.debug("TinyMCE_JcmsPlugin","[",b.id,"] [execCommand, jcmsPublink]");b.jcmsPubChooserBookmark=b.selection.getBookmark();b.selection.getRng();b.windowManager.open({file:JcmsJsContext.getBaseUrl()+"/work/pubChooser.jsp?jsFunc=tinymce.plugins.JcmsPluginCB.pubChooserCB&textFieldPubLink=true"+b.wsIdParam+c,width:900+b.getLang("jcms.delta_width",0),height:500+b.getLang("jcms.delta_height",0),inline:1,popup_css:false},{plugin_url:d,resizable:"yes",scrollbars:"yes"})});b.addCommand("jcmsMedia",function(){JcmsLogger.debug("TinyMCE_JcmsPlugin","[",b.id,"] [execCommand, jcmsMedia]");b.jcmsMediaBookmark=b.selection.getBookmark();b.selection.getRng();b.windowManager.open({file:JcmsJsContext.getBaseUrl()+"/work/mediaBrowser.jsp?jsFunc=tinymce.plugins.JcmsPluginCB.mediaBrowserCB&media=all"+b.wsIdParam+c,width:930+b.getLang("jcms.delta_width",0),height:570+b.getLang("jcms.delta_height",0),inline:1,popup_css:false},{plugin_url:d,resizable:"no",scrollbars:"no"})});b.addCommand("jcmsInvisible",function(){JcmsLogger.debug("TinyMCE_JcmsPlugin","[",b.id,"] [execCommand, jcmsInvisible]");b.focus();b.undoManager.add();var h=b.selection.isCollapsed()?"jcms.local-style-block":"jcms.local-style-inline";var g={classname:"invisibleZone"};b.formatter.toggle(h,g);b.undoManager.add()});b.addCommand("jcmsDocChooser",function(){JcmsLogger.debug("TinyMCE_JcmsPlugin","[",b.id,"] [execCommand, jcmsDocChooser]");b.jcmsPubChooserBookmark=b.selection.getBookmark();b.jcmsMediaBookmark=b.jcmsPubChooserBookmark;b.selection.getRng();b.windowManager.open({file:JcmsJsContext.getBaseUrl()+"/work/docChooser.jsp?nbElt=1&pstatus=0&jsFunc=tinymce.plugins.JcmsPluginCB.docChooserCB"+b.wsIdParam+c,width:640+b.getLang("jcms.delta_width",0),height:600+b.getLang("jcms.delta_height",0),inline:1,popup_css:false},{plugin_url:d,resizable:"no",scrollbars:"no"})});b.addCommand("jcmsWikiPreview",function(){JcmsLogger.debug("TinyMCE_JcmsPlugin","[",b.id,"] [execCommand, jcmsWikiPreview]");b.save();var g=getFormName(window.document,b.getElement().form);var i=parseInt($(b.getElement()).getJcmsId("POS_"),10);var h=getFormElementPos(b.getElement().form,b.getElement().name)+i;b.windowManager.open({file:JcmsJsContext.getBaseUrl()+"/work/wikiPopup.jsp?targetInput=document."+g+".elements["+h+"].value",width:parseInt(b.getParam("plugin_preview_width","550")),height:parseInt(b.getParam("plugin_preview_height","600")),resizable:"yes",scrollbars:"yes",popup_css:b.baseURI.toAbsolute("themes/"+b.settings.theme+"/skins/"+b.settings.skin+"/content.css"),inline:b.getParam("plugin_preview_inline",1),popup_css:false},{base:b.documentBaseURI.getURI()})});b.addCommand("jcmsWikiLoad",function(){JcmsLogger.debug("TinyMCE_JcmsPlugin","[",b.id,"] [execCommand, jcmsWikiLoad]");b.load()});b.addCommand("jcmsWikiSave",function(){JcmsLogger.debug("TinyMCE_JcmsPlugin","[",b.id,"] [execCommand, jcmsWikiSave]");b.save()});b.addCommand("jcmsCode",function(){b.execCommand("mceBeginUndoLevel");b.execCommand("mceToggleFormat",false,"jcmsCode");b.execCommand("mceEndUndoLevel")});b.addButton("jcmsDocChooser",{title:"jcms.docchooser_desc",cmd:"jcmsDocChooser","class":"mceJcmsIcon mceJcms_DocChooser"});b.addButton("jcmsPublink",{title:"jcms.publink_desc",cmd:"jcmsPublink","class":"mceJcmsIcon mceJcms_Publink"});b.addButton("jcmsInvisible",{title:"jcms.invisible_desc",cmd:"jcmsInvisible","class":"mceJcmsIcon mceJcms_Invisible"});b.addButton("jcmsMedia",{title:"jcms.media_desc",cmd:"jcmsMedia","class":"mceJcmsIcon mceJcms_Media"});b.addButton("jcmsWikiCode",{title:"jcms.wikicode_desc",cmd:"mceCodeEditor","class":"mceJcmsIcon mceJcms_WikiCode"});b.addButton("jcmsWikiPreview",{title:"preview.preview_desc",cmd:"jcmsWikiPreview","class":"mce_preview"});b.addButton("jcmsWikiLoad",{title:"Load Wiki 2 HTML (I18N)",cmd:"jcmsWikiLoad","class":"mceJcmsIcon mceJcms_Wiki2Html"});b.addButton("jcmsWikiSave",{title:"Save HTML 2 Wiki (I18N)",cmd:"jcmsWikiSave","class":"mceJcmsIcon mceJcms_Html2Wiki"});b.addButton("jcmsCode",{title:"jcms.code_desc",cmd:"jcmsCode","class":"mceJcmsIcon mceJcms_Code"});b.onInit.add(function(g){JcmsLogger.debug("TinyMCE_JcmsPlugin","[",g.id,"] [onInit] - Editor initialized");if(JCMS&&JCMS.wysiwyg&&JCMS.wysiwyg.TinyMceCB){JCMS.wysiwyg.TinyMceCB.initInstanceCB(g)}if(!e.isWikiwyg){if("formRichText"===g.settings.editor_selector){e._selectItemInGlobalStyleMenu(g.jcmsGlobalStyle);e._hideToolbars()}}else{var h=$(g.id+"_path_row");if(h){h.hide()}}});if(e.isWikiwyg){e._initWikiwyg(b,d)}else{e._initWysiwyg(b,d)}},_initWysiwyg:function(b,c){var d=this;b.jcmsStylesHash=$H(b.settings.jcms_styles);b.jcmsGlobalStyle=b.jcmsStylesHash.keys().first();JcmsLogger.debug("TinyMCE_JcmsPlugin","[",b.id,"] [init] Default global style:",b.jcmsGlobalStyle);b.onBeforeSetContent.add(function(f,k){JcmsLogger.debug("TinyMCE_JcmsPlugin","[",f.id,"] [onBeforeSetContent]");if(!k.content.startsWith('<div class="')){var j="mceContentBody wysiwyg "+f.jcmsGlobalStyle+" "+f.settingsBodyClass;f.dom.setAttrib(f.getBody(),"class",j);JcmsLogger.debug("TinyMCE_JcmsPlugin","[",f.id,'] [onBeforeSetContent] - (default) bodyClasses="',j,'"');return}var l='<div class="'.length;var h=k.content.indexOf('">');var g=k.content.substr(l,h-l);f.jcmsEditorClasses=g;tinymce.each(f.jcmsEditorClasses.split(" "),function(m){if(!Object.isUndefined(f.jcmsStylesHash.get(m))){f.jcmsGlobalStyle=m;JcmsLogger.debug("TinyMCE_JcmsPlugin","[",f.id,"] [onBeforeSetContent] - using previously saved global style:",m)}});JcmsLogger.debug("TinyMCE_JcmsPlugin","[",f.id,'] [onBeforeSetContent] - jcmsEditorClasses="',f.jcmsEditorClasses,'", jcmsGlobalStyle="',f.jcmsGlobalStyle,'"');d._selectItemInGlobalStyleMenu(f.jcmsGlobalStyle);var j="mceContentBody wysiwyg "+f.jcmsGlobalStyle+" "+f.settingsBodyClass;f.dom.setAttrib(f.getBody(),"class",j);JcmsLogger.debug("TinyMCE_JcmsPlugin","[",f.id,'] [onBeforeSetContent] - bodyClasses="',j,'"');var e=k.content.indexOf('">')+('">'.length);var i=k.content.lastIndexOf("</div>");if(e>42){e=0}if(i<(k.content.length-10)){i=k.content.length}k.content=k.content.substring(e,i);JcmsLogger.debug("TinyMCE_JcmsPlugin","[",f.id,'] [onBeforeSetContent] - o.content="',k.content,'"')});b.onGetContent.add(function(e,f){JcmsLogger.debug("TinyMCE_JcmsPlugin","[",e.id,"] [onGetContent]");f.content=d._wrapContentWithStyle(f.content,d._getCSSGroup())});b.onNodeChange.add(function(i,l,k){var f=i.controlManager.get("jcmsLcStyles");var j=i.controlManager.get("jcmsInvisible");var m=!!f;var g=!!j;if(!m&&g){return}var n=false;var h=k;do{if(m){$w(i.dom.getAttrib(h,"class")).each(function(e){if(d._selectItemInLocalStyleMenu(e)){m=false}})}if(g&&i.dom.hasClass(h,"invisibleZone")){n=true;g=false}}while((h=h.parentNode));if(j){j.setActive(n)}})},_initWikiwyg:function(b,c){var d=this;b.onBeforeSetContent.add(function(e,f){f.content=d._jcmswiki2html(f.content)});b.onPostProcess.add(function(e,f){if(f.set){f.content=d._jcmswiki2html(f.content)}if(f.get){f.content=d._html2jcmswiki(f.content)}})},createControl:function(g,b){var f=this;var c=this.editor;switch(g){case"jcmsGlStyles":JcmsLogger.debug("TinyMCE_JcmsPlugin","[",c.id,"] [createControl, jcmsGlStyles] Create CSS Group (global styles) listbox");var e=b.createListBox("jcmsGlStyles",{title:"jcms.global_styles_desc",onselect:function(h){JcmsLogger.debug("TinyMCE_JcmsPlugin","[",c.id,'] [jcmsGlStyles] - style="',h,'"');c.jcmsEditorClasses="wysiwyg "+h;c.jcmsGlobalStyle=h;c.dom.setAttrib(c.getBody(),"class","mceContentBody "+c.jcmsEditorClasses+" "+c.settingsBodyClass);f._updateLocalStylesMenu()}});c.jcmsStylesHash.each(function(h){var i=h.key;e.add(i,i)});return e;case"jcmsLcStyles":JcmsLogger.debug("TinyMCE_JcmsPlugin","[",c.id,"] [createControl, jcmsLcStyles] Create CSS (local styles) listbox");var d=b.createListBox("jcmsLcStyles",{title:"jcms.local_styles_desc",onselect:function(j){var i=c.selection.getNode();JcmsLogger.debug("TinyMCE_JcmsPlugin","[",c.id,"] [jcmsLcStyles] - node=",i,' className="',j,'"');c.focus();c.undoManager.add();var h=c.selection.isCollapsed()?"jcms.local-style-block":"jcms.local-style-inline";if(c.jcmsGlobalStyle&&c.jcmsStylesHash.get(c.jcmsGlobalStyle)){$A(c.jcmsStylesHash.get(c.jcmsGlobalStyle)).each(function(k){if(k===j){return}c.formatter.remove(h,{classname:k})})}c.formatter.toggle(h,{classname:j});c.undoManager.add();c.nodeChanged();return true}});return d}return null},_wrapContentWithStyle:function(f,e){var d=this.editor;JcmsLogger.debug("TinyMCE_JcmsPlugin","[",d.id,'] [_wrapContentWithStyle] - style: "',e,'"');if(!f||/^\s*$/.test(f)){JcmsLogger.debug("TinyMCE_JcmsPlugin","[",d.id,"] [_wrapContentWithStyle] - no content or content empty");return f}if(!f.startsWith('<div class="')){var c='<div class="'+e+'">'+f+"</div>";JcmsLogger.debug("TinyMCE_JcmsPlugin","[",d.id,"] [_wrapContentWithStyle] - no surrounding div, adding one");return c}var b=f.indexOf('">')+('">'.length);var c='<div class="'+e+'">'+f.substr(b);JcmsLogger.debug("TinyMCE_JcmsPlugin","[",d.id,"] [_wrapContentWithStyle] - existing surrounding div updated");return c},_getCSSGroup:function(){var b=this.editor;var c=b.jcmsEditorClasses;if(!c){c="wysiwyg "+(b.jcmsGlobalStyle||"")}if(c.indexOf("wysiwyg")==-1){c="wysiwyg "+c}JcmsLogger.debug("TinyMCE_JcmsPlugin","[",b.id,'] [_getCSSGroup] - returns "',c,'"');return c},_updateLocalStylesMenu:function(){var b=this.editor;JcmsLogger.debug("TinyMCE_JcmsPlugin","[",b.id,"] [_updateLocalStylesMenu]");if(!b.jcmsGlobalStyle||!b.jcmsStylesHash.get(b.jcmsGlobalStyle)){return}var c=b.controlManager.get("jcmsLcStyles");if(c){c.items=[];c.selectedValue=null;if(c.isMenuRendered){c.menu.destroy();c.menu=null;c.isMenuRendered=false;c.oldID=0}$A(b.jcmsStylesHash.get(b.jcmsGlobalStyle)).each(function(d){c.add(d,d)})}},_selectItemInGlobalStyleMenu:function(d){var b=this.editor;var c=b.controlManager.get("jcmsGlStyles");if(!c){return}c.select(d);this._updateLocalStylesMenu();return !!c.selectedValue},_selectItemInLocalStyleMenu:function(d){var b=this.editor;var c=b.controlManager.get("jcmsLcStyles");if(!c){return}c.select(d);return !!c.selectedValue},_hideToolbars:function(){var c=this.editor;JcmsLogger.debug("TinyMCE_JcmsPlugin","[",c.id,"] [_hideToolbars]");var g=c.getParam("jcms_toolbars")||c.getElement().getAttribute("title");c.settings.jcms_toolbars=g;JcmsLogger.debug("TinyMCE_JcmsPlugin","[",c.id,'] [_hideToolbars] - textarea title:"',g,'"');var f=$A(new Array("basic","format","style","font","table"));if(!g){return}if(g.indexOf("none")!=-1){var h=$($(c.id+"_toolbar1").parentNode);h.hide();var e=$(c.id+"_ifr");var b=parseFloat(e.style.height||0);e.style.height=(4+(4*22)+b)+"px";return}if(g.indexOf("style")==-1&&g.indexOf("font")==-1){this._hideToolbarFeatureSet("styleandfont")}var d=this;f.each(function(i){if(g.indexOf(i)==-1){d._hideToolbarFeatureSet(i)}})},_hideToolbarFeatureSet:function(n){var o=this.editor;JcmsLogger.debug("TinyMCE_JcmsPlugin","[",o.id,'] [_hideToolbarFeatureSet("',n,'")]');var p=null;var g=o.id+"_";var m=o.id+"_";switch(n){case"basic":p=o.id+"_toolbar1";break;case"format":p=o.id+"_toolbar2";break;case"style":g+="styleprops";m+="jcmsLcStyles";break;case"font":g+="fontselect";m+="backcolor";break;case"styleandfont":p=o.id+"_toolbar3";break;case"table":p=o.id+"_toolbar4";break}var c=$(p);if(c){c.hide();var f=$(o.id+"_ifr");var q=parseFloat(f.style.height||0);f.style.height=(23+q)+"px";return}var l=$(g);var b=$(m);if(!l||!b){return}var e=false;var k;if(l.hasClassName("mceButton")){k=l.parentNode.parentNode}else{if(l.hasClassName("mceListBox")){k=l.parentNode.parentNode.parentNode}else{return}}for(var h=0;h<k.childNodes.length;h++){var j=$(k.childNodes[h]);var d=$(j.firstChild);if(d.tagName.toLowerCase()==="span"&&Object.isElement(d.firstChild)&&d.firstChild.tagName.toLowerCase()==="table"){d=$(d.firstChild)}if(d.id===g){e=true}if(!e){continue}j.hide();if(d.id===m){e=false;break}}},_html2jcmswiki:function(c){c=HTML2Wiki(c);var d={"&lt;":"<","&gt;":">","&quot;":'"',"&apos;":"'"};for(var b in d){if(d.hasOwnProperty(b)){c=c.replace(new RegExp(b,"gi"),d[b])}}c=c.replace(new RegExp("&amp;","gi"),"&");return c},_jcmswiki2html:function(c){c=c.replace(new RegExp("&","gi"),"&amp;");var d={'"':"&quot;","'":"&#39;","<":"&lt;",">":"&gt;"};for(var b in d){if(d.hasOwnProperty(b)){c=c.replace(new RegExp(b,"gi"),d[b])}}c=Wiki2HTML(c);return c}});tinymce.PluginManager.add("jcms",tinymce.plugins.JcmsPlugin)})();tinymce=tinymce||{};tinymce.plugins=tinymce.plugins||{};tinymce.plugins.JcmsPluginCB={pubChooserCB:function(e,c,f){var b=tinyMCE.activeEditor;JcmsLogger.debug("TinyMCE_JcmsPluginCB","[",b.id,"] [pubChooserCB] id=",e,', label="',c,'", url=',f);if(!e&&!f){JcmsLogger.debug("TinyMCE_JcmsPluginCB","[",b.id,"] [pubChooserCB] no id or URL retrieved");return}if(!f){f="display.jsp?id="+id;JcmsLogger.warn("TinyMCE_JcmsPluginCB","[",b.id,"] [pubChooserCB] displayURL missing, using ",f)}var g=b.selection.getNode();g=b.dom.getParent(g,"A");b.undoManager.add();if(g==null){JcmsLogger.debug("TinyMCE_JcmsPluginCB","[",b.id,"] [pubChooserCB] creating new <a> element");b.selection.moveToBookmark(b.jcmsPubChooserBookmark);var a=b.selection.getContent();var d='<a href="'+f+'">'+(!a?c:a)+"</a>";b.execCommand("mceInsertContent",false,d)}else{JcmsLogger.debug("TinyMCE_JcmsPluginCB","[",b.id,"] [pubChooserCB] updating href of existing <a> element");b.dom.setAttribs(g,{href:f})}b.undoManager.add()},mediaBrowserCB:function(b,g,h,i,d,c,m,l,k,j){var f=tinyMCE.activeEditor;JcmsLogger.debug("TinyMCE_JcmsPluginCB","[",f.id,"] [mediaBrowserCB] id=",b,', title="',g,'" mediaType="',h,'", url="',i,'", p1=',m,'", p2=',l,'", p3=',k,'", p4=',j);var e="";switch(h){case"image":var a=tinymce.DOM.encode(g);e+='<img src="'+i+'" alt="'+a+'" title="'+a+'."';if(m){e+=' width="'+m+'"'}if(l){e+=' height="'+l+'"'}e+="/>";break;case"video":case"flash":case"audio":e=tinymce.plugins.JcmsPluginCB._insertMedia(i,h);if(e==null){JcmsLogger.warn("TinyMCE_JcmsPluginCB","[",f.id,"] [mediaBrowserCB] media type not yet supported",i);return}break;default:JcmsLogger.warn("TinyMCE_JcmsPluginCB","[",f.id,"] [mediaBrowserCB] invalid media type",h);return}f.selection.moveToBookmark(f.jcmsMediaBookmark);f.execCommand("mceInsertContent",false,e)},_insertMedia:function(f,l){var g=tinyMCE.activeEditor;JcmsLogger.debug("TinyMCE_JcmsPluginCB","[",g.id,'] [_insertMedia] mediaSrc="',f,'", mediaType="',l,'"');var h={params:{src:f},video:{sources:[{src:f}]},type:l};var j=f.replace(/^.*\.([^.]+)$/,"$1");var b=g.getParam("jcms_video_selector",/(mp4|m4v|f4v|mov|webm|flv|ogv)/);var d=g.getParam("jcms_audio_selector",/(aac|m4a|f4a|ogg|oga|mp3)/);if("video"==l&&b.test(j)){var c=g.getParam("jcms_video_data",{type:"flash",params:{src:"flash/lib/player.swf",flashvars:"file=${baseUrl}$url",WMode:"opaque"},width:"320",height:"260"});tinymce.extend(h,c)}else{if("audio"==l&&d.test(j)){var a=g.getParam("jcms_audio_data",{type:"flash",params:{src:"flash/lib/player.swf",flashvars:"file=${baseUrl}$url",WMode:"opaque"},width:"230",height:"24"});tinymce.extend(h,a)}else{var k=g.plugins.media.getType(j);if(k){var i=k.name.toLowerCase();h.type=i}else{return null}}}var e=g.plugins.media.dataToHtml(h,true);e=e.replace(/\$url/g,f);return e},jcmsFileBrowserCB:function(f,d,e,g){JcmsLogger.debug("TinyMCE_JcmsPluginCB","[jcmsFileBrowser]",arguments);var c={file:"",width:930,height:570,resizable:"no",scrollbars:"no",close_previous:"no",popup_css:false};var a=tinyMCE.activeEditor;var b=(a.getElement?("&lang="+a.getElement().getAttribute("lang")):"");switch(e){case"image":c.file=JcmsJsContext.getBaseUrl()+"/work/mediaBrowser.jsp?tinyMCEPopup=true&medias=image&media=image"+a.wsIdParam+b;break;case"media":c.file=JcmsJsContext.getBaseUrl()+"/work/mediaBrowser.jsp?tinyMCEPopup=true&media=all"+a.wsIdParam+b;break;case"file":c.file=JcmsJsContext.getBaseUrl()+"/work/pubChooser.jsp?tinyMCEPopup=true&textFieldPubLink=true&pubChooserMenu=true"+a.wsIdParam+b;c.width=900;c.height=500;c.resizable="yes";c.scrollbars="yes";break}tinyMCE.activeEditor.windowManager.open(c,{window:g,input:f});return false},docChooserCB:function(a){JcmsLogger.debug("TinyMCE_JcmsPluginCB","[docChooserCB]",arguments);$A(a).each(function(b){if(b.mediaType==="other"){tinymce.plugins.JcmsPluginCB.pubChooserCB(b.id,b.title,b.displayUrl)}else{tinymce.plugins.JcmsPluginCB.mediaBrowserCB(b.id,b.title,b.mediaType,b.filename)}})}};